name: release-windows

on:
  push:
    tags: [ "v*" ]

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: windows-latest

    env:
      # Set to placeholders so YAML tooling understands these exist.
      # Real values are set at runtime by the "Compute version" step via GITHUB_ENV.
      APP_VERSION: "0.0.0"
      ASSEMBLY_VERSION: "0.0.0.0"
      FILE_VERSION: "0.0.0.0"
      INFORMATIONAL_VERSION: "0.0.0+local"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Inno Setup (for installer build)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path -LiteralPath $iscc)) {
            choco install innosetup -y --no-progress
          }
          if (-not (Test-Path -LiteralPath $iscc)) { throw "ISCC.exe not found: $iscc" }
          Get-Item -LiteralPath $iscc | Select-Object FullName, Length, LastWriteTime | Format-List

      - name: Setup cosign (Sigstore)
        uses: sigstore/cosign-installer@v3

      - name: Compute version (from tag)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $refType = '${{ github.ref_type }}'
          $refName = '${{ github.ref_name }}'
          if ($refType -ne 'tag') { throw "Expected tag ref, got: $refType / $refName" }
          if (-not $refName.StartsWith('v')) { throw "Tag must start with 'v' (example: v1.2.3). Got: $refName" }

          $tagVersion = $refName.Substring(1)
          if ($tagVersion -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
            throw "Tag '$refName' must be v<major>.<minor>.<patch>[.<revision>]"
          }

          $parts = $tagVersion.Split('.')
          if ($parts.Count -eq 3) { $parts = @($parts[0], $parts[1], $parts[2], '0') }

          $appVersion = ($parts[0..2] -join '.')
          $assemblyVersion = ($parts -join '.')
          $fileVersion = $assemblyVersion
          $informational = "$appVersion+tag.$refName"

          "APP_VERSION=$appVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ASSEMBLY_VERSION=$assemblyVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "FILE_VERSION=$fileVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "INFORMATIONAL_VERSION=$informational" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "Release version: $refName -> APP_VERSION=$appVersion"

      - name: Restore
        run: dotnet restore "cm6206_dual_router/Cm6206DualRouter.csproj"

      - name: Build
        run: dotnet build "cm6206_dual_router/Cm6206DualRouter.csproj" -c Release --no-restore

      - name: Publish (self-contained single file)
        shell: pwsh
        run: |
          dotnet publish "cm6206_dual_router/Cm6206DualRouter.csproj" `
            -c Release `
            -r win-x64 `
            --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:PublishReadyToRun=true `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:Version=$env:APP_VERSION `
            /p:AssemblyVersion=$env:ASSEMBLY_VERSION `
            /p:FileVersion=$env:FILE_VERSION `
            /p:InformationalVersion=$env:INFORMATIONAL_VERSION `
            -o "artifacts/cm6206_dual_router_win-x64"

      - name: Sign published EXE (optional)
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets['CODESIGN_PFX_BASE64'] }}
          CODESIGN_PFX_PASSWORD: ${{ secrets['CODESIGN_PFX_PASSWORD'] }}
          CODESIGN_TIMESTAMP_URL: ${{ secrets['CODESIGN_TIMESTAMP_URL'] }}
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_BASE64) -or [string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_PASSWORD)) {
            Write-Host 'Code signing skipped (CODESIGN_PFX_BASE64 / CODESIGN_PFX_PASSWORD not set).'
            exit 0
          }

          try {
            $artifactDir = Join-Path $PWD 'artifacts/cm6206_dual_router_win-x64'
            $exe = Join-Path $artifactDir 'Cm6206DualRouter.exe'
            if (-not (Test-Path -LiteralPath $exe)) {
              throw "Expected publish output not found: $exe"
            }

            $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
            [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))

            $timestamp = $env:CODESIGN_TIMESTAMP_URL
            if ([string]::IsNullOrWhiteSpace($timestamp)) { $timestamp = 'http://timestamp.digicert.com' }

          function Find-SignTool {
            $cmd = Get-Command signtool.exe -ErrorAction SilentlyContinue
            if ($cmd) { return $cmd.Source }

            $roots = @(
              'C:\Program Files (x86)\Windows Kits\10\bin',
              'C:\Program Files\Windows Kits\10\bin'
            )

            foreach ($root in $roots) {
              if (-not (Test-Path -LiteralPath $root)) { continue }
              $found = Get-ChildItem -LiteralPath $root -Recurse -Filter signtool.exe -ErrorAction SilentlyContinue |
                Sort-Object FullName -Descending |
                Select-Object -First 1
              if ($found) { return $found.FullName }
            }

            return $null
          }

          $signtool = Find-SignTool
          if ([string]::IsNullOrWhiteSpace($signtool)) {
            Write-Host 'Code signing skipped (signtool.exe not found on runner).'
            exit 0
          }

          Write-Host "Using signtool: $signtool"

          & $signtool sign /fd sha256 /a /f $pfxPath /p $env:CODESIGN_PFX_PASSWORD /tr $timestamp /td sha256 $exe
          & $signtool verify /pa /v $exe
          }
          catch {
            Write-Warning "Code signing failed (continuing without signing): $($_.Exception.Message)"
            exit 0
          }

      - name: Generate UI assets (PNG/SVG/9-slice)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          dotnet run -c Release --project tools/Cm6206AssetGenerator -- --out "artifacts/cm6206_dual_router_win-x64/assets/generated" --theme all

      - name: Build installer (Inno Setup)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (-not (Test-Path -LiteralPath $iscc)) { throw "ISCC.exe not found: $iscc" }

          New-Item -ItemType Directory -Force -Path "artifacts/installer" | Out-Null

          & $iscc "installer/Cm6206DualRouter.iss" "/DMyAppVersion=$env:APP_VERSION"

          $setupExe = Join-Path $PWD "artifacts/installer/Cm6206DualRouterSetup_$($env:APP_VERSION).exe"
          if (-not (Test-Path -LiteralPath $setupExe)) { throw "Installer output not found: $setupExe" }

      - name: Package ZIP
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $src = Join-Path $PWD 'artifacts/cm6206_dual_router_win-x64'
          if (-not (Test-Path -LiteralPath $src)) {
            throw "Publish output not found: $src"
          }

          $zipPath = Join-Path $PWD ("artifacts/cm6206_dual_router_win-x64_{0}.zip" -f $env:APP_VERSION)
          if (Test-Path -LiteralPath $zipPath) { Remove-Item -LiteralPath $zipPath -Force }
          Compress-Archive -Path (Join-Path $src '*') -DestinationPath $zipPath
          Write-Host "Created: $zipPath"

      - name: Cosign release assets (keyless)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $outDir = Join-Path $PWD 'artifacts/cosign'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $exe = Join-Path $PWD 'artifacts/cm6206_dual_router_win-x64/Cm6206DualRouter.exe'
          $zip = Join-Path $PWD ("artifacts/cm6206_dual_router_win-x64_{0}.zip" -f $env:APP_VERSION)
          $setup = Join-Path $PWD ("artifacts/installer/Cm6206DualRouterSetup_{0}.exe" -f $env:APP_VERSION)

          foreach ($f in @($exe, $zip, $setup)) {
            if (-not (Test-Path -LiteralPath $f)) { throw "Expected file not found: $f" }
          }

          # Keyless signing uses GitHub OIDC; requires workflow permission: id-token: write
          cosign sign-blob --yes --output-signature (Join-Path $outDir 'Cm6206DualRouter.exe.sig') --output-certificate (Join-Path $outDir 'Cm6206DualRouter.exe.crt') $exe
          cosign sign-blob --yes --output-signature (Join-Path $outDir ("cm6206_dual_router_win-x64_{0}.zip.sig" -f $env:APP_VERSION)) --output-certificate (Join-Path $outDir ("cm6206_dual_router_win-x64_{0}.zip.crt" -f $env:APP_VERSION)) $zip
          cosign sign-blob --yes --output-signature (Join-Path $outDir ("Cm6206DualRouterSetup_{0}.exe.sig" -f $env:APP_VERSION)) --output-certificate (Join-Path $outDir ("Cm6206DualRouterSetup_{0}.exe.crt" -f $env:APP_VERSION)) $setup

      - name: Upload artifact (cosign)
        uses: actions/upload-artifact@v4
        with:
          name: cosign_${{ env.APP_VERSION }}
          path: artifacts/cosign/

      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: cm6206_dual_router_win-x64_${{ env.APP_VERSION }}_zip
          path: artifacts/cm6206_dual_router_win-x64_${{ env.APP_VERSION }}.zip

      - name: Upload artifact (installer)
        uses: actions/upload-artifact@v4
        with:
          name: cm6206_dual_router_setup_${{ env.APP_VERSION }}
          path: artifacts/installer/Cm6206DualRouterSetup_${{ env.APP_VERSION }}.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/cm6206_dual_router_win-x64_${{ env.APP_VERSION }}.zip
            artifacts/installer/Cm6206DualRouterSetup_${{ env.APP_VERSION }}.exe
            artifacts/cosign/Cm6206DualRouter.exe.sig
            artifacts/cosign/Cm6206DualRouter.exe.crt
            artifacts/cosign/cm6206_dual_router_win-x64_${{ env.APP_VERSION }}.zip.sig
            artifacts/cosign/cm6206_dual_router_win-x64_${{ env.APP_VERSION }}.zip.crt
            artifacts/cosign/Cm6206DualRouterSetup_${{ env.APP_VERSION }}.exe.sig
            artifacts/cosign/Cm6206DualRouterSetup_${{ env.APP_VERSION }}.exe.crt
          generate_release_notes: true
