name: build-windows

on:
  push:
    branches: [ "main" ]
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $runNumber = [int]'${{ github.run_number }}'
          $sha = '${{ github.sha }}'
          $shortSha = if ($sha.Length -ge 7) { $sha.Substring(0, 7) } else { $sha }

          $refType = '${{ github.ref_type }}'
          $refName = '${{ github.ref_name }}'

          if ($refType -eq 'tag' -and $refName.StartsWith('v')) {
            $tagVersion = $refName.Substring(1)
            if ($tagVersion -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
              throw "Tag '$refName' must be v<major>.<minor>.<patch>[.<revision>]"
            }

            $parts = $tagVersion.Split('.')
            if ($parts.Count -eq 3) { $parts = @($parts[0], $parts[1], $parts[2], '0') }

            $appVersion = ($parts[0..2] -join '.')
            $assemblyVersion = ($parts -join '.')
            $fileVersion = $assemblyVersion
            $informational = "$appVersion+tag.$refName"
          } else {
            # Auto-increment per workflow run for non-tag builds
            $appVersion = "1.0.$runNumber"
            $assemblyVersion = "1.0.$runNumber.0"
            $fileVersion = $assemblyVersion
            $informational = "$appVersion+sha.$shortSha"
          }

          "APP_VERSION=$appVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ASSEMBLY_VERSION=$assemblyVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "FILE_VERSION=$fileVersion" | Out-File -FilePath $env:GITHUB_ENV -Append
          "INFORMATIONAL_VERSION=$informational" | Out-File -FilePath $env:GITHUB_ENV -Append

          Write-Host "Version: APP_VERSION=$appVersion"
          Write-Host "         ASSEMBLY_VERSION=$assemblyVersion"
          Write-Host "         FILE_VERSION=$fileVersion"
          Write-Host "         INFORMATIONAL_VERSION=$informational"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore "cm6206_dual_router/Cm6206DualRouter.csproj"

      - name: Build
        run: dotnet build "cm6206_dual_router/Cm6206DualRouter.csproj" -c Release --no-restore

      - name: Publish (self-contained single file)
        shell: pwsh
        run: |
          dotnet publish "cm6206_dual_router/Cm6206DualRouter.csproj" `
            -c Release `
            -r win-x64 `
            --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:PublishReadyToRun=true `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:Version=$env:APP_VERSION `
            /p:AssemblyVersion=$env:ASSEMBLY_VERSION `
            /p:FileVersion=$env:FILE_VERSION `
            /p:InformationalVersion=$env:INFORMATIONAL_VERSION `
            -o "artifacts/cm6206_dual_router_win-x64"

      - name: Sign published EXE (optional)
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
          CODESIGN_TIMESTAMP_URL: ${{ secrets.CODESIGN_TIMESTAMP_URL }}
        run: |
          $ErrorActionPreference = 'Stop'

          if ([string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_BASE64) -or [string]::IsNullOrWhiteSpace($env:CODESIGN_PFX_PASSWORD)) {
            Write-Host 'Code signing skipped (CODESIGN_PFX_BASE64 / CODESIGN_PFX_PASSWORD not set).'
            exit 0
          }

          $artifactDir = Join-Path $PWD 'artifacts/cm6206_dual_router_win-x64'
          $exe = Join-Path $artifactDir 'Cm6206DualRouter.exe'
          if (-not (Test-Path -LiteralPath $exe)) {
            throw "Expected publish output not found: $exe"
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))

          $timestamp = $env:CODESIGN_TIMESTAMP_URL
          if ([string]::IsNullOrWhiteSpace($timestamp)) { $timestamp = 'http://timestamp.digicert.com' }

          function Find-SignTool {
            $cmd = Get-Command signtool.exe -ErrorAction SilentlyContinue
            if ($cmd) { return $cmd.Source }

            $roots = @(
              'C:\Program Files (x86)\Windows Kits\10\bin',
              'C:\Program Files\Windows Kits\10\bin'
            )

            foreach ($root in $roots) {
              if (-not (Test-Path -LiteralPath $root)) { continue }
              $found = Get-ChildItem -LiteralPath $root -Recurse -Filter signtool.exe -ErrorAction SilentlyContinue |
                Sort-Object FullName -Descending |
                Select-Object -First 1
              if ($found) { return $found.FullName }
            }

            throw 'signtool.exe not found on runner.'
          }

          $signtool = Find-SignTool
          Write-Host "Using signtool: $signtool"

          & $signtool sign /fd sha256 /a /f $pfxPath /p $env:CODESIGN_PFX_PASSWORD /tr $timestamp /td sha256 $exe
          & $signtool verify /pa /v $exe

      - name: Generate UI assets (PNG/SVG/9-slice)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          dotnet run -c Release --project tools/Cm6206AssetGenerator -- --out "artifacts/cm6206_dual_router_win-x64/assets/generated" --theme all

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cm6206_dual_router_win-x64_${{ env.APP_VERSION }}
          path: artifacts/cm6206_dual_router_win-x64/

