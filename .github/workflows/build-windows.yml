name: build-windows

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore "cm6206_dual_router/Cm6206DualRouter.csproj"

      - name: Build
        run: dotnet build "cm6206_dual_router/Cm6206DualRouter.csproj" -c Release --no-restore

      - name: Publish (self-contained single file)
        run: >
          dotnet publish "cm6206_dual_router/Cm6206DualRouter.csproj"
          -c Release
          -r win-x64
          --self-contained true
          /p:PublishSingleFile=true
          /p:IncludeNativeLibrariesForSelfExtract=true
          /p:PublishReadyToRun=true
          /p:DebugType=None
          /p:DebugSymbols=false
          -o "artifacts/cm6206_dual_router_win-x64"

      - name: Sign published EXE (optional)
        if: ${{ secrets.CODESIGN_PFX_BASE64 != '' && secrets.CODESIGN_PFX_PASSWORD != '' }}
        shell: pwsh
        env:
          CODESIGN_PFX_BASE64: ${{ secrets.CODESIGN_PFX_BASE64 }}
          CODESIGN_PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
          CODESIGN_TIMESTAMP_URL: ${{ secrets.CODESIGN_TIMESTAMP_URL }}
        run: |
          $ErrorActionPreference = 'Stop'
          $artifactDir = Join-Path $PWD 'artifacts/cm6206_dual_router_win-x64'
          $exe = Join-Path $artifactDir 'Cm6206DualRouter.exe'
          if (-not (Test-Path -LiteralPath $exe)) {
            throw "Expected publish output not found: $exe"
          }

          $pfxPath = Join-Path $env:RUNNER_TEMP 'codesign.pfx'
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:CODESIGN_PFX_BASE64))

          $timestamp = $env:CODESIGN_TIMESTAMP_URL
          if ([string]::IsNullOrWhiteSpace($timestamp)) { $timestamp = 'http://timestamp.digicert.com' }

          function Find-SignTool {
            $cmd = Get-Command signtool.exe -ErrorAction SilentlyContinue
            if ($cmd) { return $cmd.Source }

            $roots = @(
              'C:\Program Files (x86)\Windows Kits\10\bin',
              'C:\Program Files\Windows Kits\10\bin'
            )

            foreach ($root in $roots) {
              if (-not (Test-Path -LiteralPath $root)) { continue }
              $found = Get-ChildItem -LiteralPath $root -Recurse -Filter signtool.exe -ErrorAction SilentlyContinue |
                Sort-Object FullName -Descending |
                Select-Object -First 1
              if ($found) { return $found.FullName }
            }

            throw 'signtool.exe not found on runner.'
          }

          $signtool = Find-SignTool
          Write-Host "Using signtool: $signtool"

          & $signtool sign /fd sha256 /a /f $pfxPath /p $env:CODESIGN_PFX_PASSWORD /tr $timestamp /td sha256 $exe
          & $signtool verify /pa /v $exe

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cm6206_dual_router_win-x64
          path: artifacts/cm6206_dual_router_win-x64/

      - name: Create GitHub Release (tags)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/cm6206_dual_router_win-x64/**
